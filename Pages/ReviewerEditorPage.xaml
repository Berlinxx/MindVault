<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="mindvault.Pages.ReviewerEditorPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:controls="clr-namespace:mindvault.Controls"
    xmlns:local="clr-namespace:mindvault.Pages"
    xmlns:conv="clr-namespace:mindvault.Converters"
    Shell.NavBarIsVisible="False">

  <!-- ===== THEME ===== -->
  <ContentPage.Resources>
    <Color x:Key="Primary">#31B6D8</Color>
    <Color x:Key="PrimaryDark">#0B57C1</Color>
    <Color x:Key="Surface">#FFFFFF</Color>
    <Color x:Key="TextPrimary">#111318</Color>
    <Color x:Key="TextSecondary">#5A6573</Color>
    <Color x:Key="SoftBlue">#E7F6FB</Color>
    <Color x:Key="Divider">#E8EDF2</Color>



    <!-- Card base -->
    <Style x:Key="CardStyle" TargetType="Border">
      <Setter Property="BackgroundColor" Value="{StaticResource Surface}" />
      <Setter Property="StrokeThickness" Value="0"/>
      <Setter Property="StrokeShape" Value="RoundRectangle 18"/>
      <Setter Property="Padding" Value="16"/>
      <Setter Property="Margin" Value="24,10,24,0"/>
      <Setter Property="Shadow">
        <Setter.Value>
          <Shadow Opacity="0.18" Radius="16">
            <Shadow.Offset><Point X="0" Y="8"/></Shadow.Offset>
          </Shadow>
        </Setter.Value>
      </Setter>
    </Style>
    <conv:TruncateConverter x:Key="TruncateConverter" />

    <!-- Save pill -->
    <Style x:Key="PillPrimary" TargetType="Border">
      <Setter Property="StrokeShape" Value="RoundRectangle 16"/>
      <Setter Property="Padding" Value="10,6"/>
      <Setter Property="Background">
        <Setter.Value>
          <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
            <GradientStop Color="{StaticResource Primary}" Offset="0"/>
            <GradientStop Color="{StaticResource PrimaryDark}" Offset="1"/>
          </LinearGradientBrush>
        </Setter.Value>
      </Setter>
      <Setter Property="VisualStateManager.VisualStateGroups">
        <Setter.Value>
          <VisualStateGroupList>
            <VisualStateGroup>
              <VisualState x:Name="Normal"/>
              <VisualState x:Name="Pressed">
                <VisualState.Setters>
                  <Setter Property="VisualElement.Opacity" Value="0.92"/>
                </VisualState.Setters>
              </VisualState>
            </VisualStateGroup>
          </VisualStateGroupList>
        </Setter.Value>
      </Setter>
    </Style>
  </ContentPage.Resources>

  <!-- ===== BACKGROUND ===== -->
  <ContentPage.Background>
    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
      <GradientStop Color="#3CC5F0" Offset="0" />
      <GradientStop Color="#0B57C1" Offset="1" />
    </LinearGradientBrush>
  </ContentPage.Background>

  <Grid x:Name="MainGrid" RowDefinitions="Auto,*">

    <!-- ===== HEADER ===== -->
    <Border Grid.Row="0" BackgroundColor="White" StrokeThickness="0"
            StrokeShape="RoundRectangle 0,0,18,18"
            Padding="12,10" Margin="0,0,0,6">
      <Grid ColumnDefinitions="Auto,*,Auto,Auto" VerticalOptions="Center">

        <!-- Burger -->
        <controls:HamburgerButton x:Name="HamburgerButton" />

        <!-- Title + pencil -->
        <HorizontalStackLayout Grid.Column="1" Spacing="8" VerticalOptions="Center">
             <Label x:Name="TitleLabel"
               Text="{Binding ReviewerTitle, Converter={StaticResource TruncateConverter}, ConverterParameter=15}"
               FontAttributes="Bold" FontSize="18" TextColor="{StaticResource TextPrimary}"
               SemanticProperties.HeadingLevel="Level1"
               SemanticProperties.Description="Deck title"/>
          <Border WidthRequest="28" HeightRequest="28" StrokeThickness="1" Stroke="#E7E7E7"
                  StrokeShape="Ellipse" BackgroundColor="White" HorizontalOptions="Center" VerticalOptions="Center"
                  ToolTipProperties.Text="Edit title (Ctrl+E)"
                  SemanticProperties.Description="Edit deck title button"
                  SemanticProperties.Hint="Press to rename this deck">
            <Label Text="&#xF304;" FontFamily="FontAwesome6FreeSolid" FontSize="12" TextColor="#3C4CF3"
                   HorizontalOptions="Center" VerticalOptions="Center"/>
            <Border.GestureRecognizers>
              <TapGestureRecognizer Tapped="OnEditTitleTapped"/>
            </Border.GestureRecognizers>
          </Border>
        </HorizontalStackLayout>

        <!-- Shortcuts button (keyboard icon) -->
        <Border Grid.Column="2" WidthRequest="34" HeightRequest="34"
                StrokeThickness="1" Stroke="#E7E7E7" StrokeShape="Ellipse"
                BackgroundColor="White" Margin="0,0,8,0"
                ToolTipProperties.Text="Keyboard shortcuts (Ctrl+H)"
                SemanticProperties.Description="Show keyboard shortcuts"
                SemanticProperties.Hint="View available keyboard shortcuts for quick actions">
          <Label Text="&#xF11C;" FontFamily="FontAwesome6FreeSolid" FontSize="13" TextColor="#31B6D8"
                 HorizontalOptions="Center" VerticalOptions="Center"/>
          <Border.GestureRecognizers>
            <TapGestureRecognizer Tapped="OnShortcutsTapped"/>
          </Border.GestureRecognizers>
        </Border>

        <!-- Check button (global save - decorative) -->
        <Border Grid.Column="3" WidthRequest="34" HeightRequest="34"
                StrokeThickness="0" StrokeShape="Ellipse"
                ToolTipProperties.Text="Save and exit (Ctrl+Enter)"
                SemanticProperties.Description="Save and exit button"
                SemanticProperties.Hint="Save all changes and return to reviewers page">
          <Border.Background>
            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
              <GradientStop Color="{StaticResource Primary}" Offset="0"/>
              <GradientStop Color="{StaticResource PrimaryDark}" Offset="1"/>
            </LinearGradientBrush>
          </Border.Background>
          <Label Text="&#xF00C;" FontFamily="FontAwesome6FreeSolid" FontSize="14" TextColor="White"
                 HorizontalOptions="Center" VerticalOptions="Center"/>
          <Border.GestureRecognizers>
            <TapGestureRecognizer Tapped="OnCheckTapped"/>
          </Border.GestureRecognizers>
        </Border>

      </Grid>
    </Border>

    <!-- ===== BODY ===== -->
    <Grid Grid.Row="1">
      <ScrollView>
        <VerticalStackLayout Spacing="10" HorizontalOptions="Fill">
          <VerticalStackLayout.Padding>
            <OnPlatform x:TypeArguments="Thickness">
              <On Platform="WinUI" Value="15,6,15,20"/>
              <On Platform="Android,iOS,MacCatalyst" Value="0,6,0,20"/>
            </OnPlatform>
          </VerticalStackLayout.Padding>

          <!-- Items list -->
          <CollectionView ItemsSource="{Binding Items}" SelectionMode="None">
            <CollectionView.ItemsLayout>
              <LinearItemsLayout Orientation="Vertical" ItemSpacing="4" />
            </CollectionView.ItemsLayout>
            <CollectionView.ItemTemplate>
              <DataTemplate>
                <Border Style="{StaticResource CardStyle}">
                  <Grid>

                    <!-- Trash (top-right) -->
                    <Border WidthRequest="36" HeightRequest="36"
                            HorizontalOptions="End" VerticalOptions="Start"
                            Stroke="#EFEFEF" StrokeThickness="1" StrokeShape="Ellipse"
                            BackgroundColor="White" Margin="0,-8,-8,0"
                            ToolTipProperties.Text="Delete card">
                      <Label Text="&#xF2ED;" FontFamily="FontAwesome6FreeSolid" FontSize="14" TextColor="#6C4DF7"
                             HorizontalOptions="Center" VerticalOptions="Center"/>
                      <Border.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnDeleteTapped"/>
                      </Border.GestureRecognizers>
                    </Border>

                    <!-- ===== EDIT PANEL (unsaved) ===== -->
                    <VerticalStackLayout x:Name="EditPanel" Spacing="10" Margin="0,0,40,0"
                                         IsVisible="{Binding IsEditing}">
                      <Grid ColumnDefinitions="Auto,Auto,*" VerticalOptions="Start">
                        <Label Text="New" FontAttributes="Bold" TextColor="#6C4DF7"/>
                        <!-- Save pill -->
                        <Border Grid.Column="1" Style="{StaticResource PillPrimary}" Margin="8,0,0,0"
                                ToolTipProperties.Text="Save card (Ctrl+S)">
                          <HorizontalStackLayout Spacing="6">
                            <Label Text="&#xF0C7;" FontFamily="FontAwesome6FreeSolid" FontSize="12" TextColor="White"/>
                            <Label Text="SAVE" FontAttributes="Bold" FontSize="12" TextColor="White"/>
                          </HorizontalStackLayout>
                          <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnSaveTapped"/>
                          </Border.GestureRecognizers>
                        </Border>
                      </Grid>

                      <Label Text="Question (definition)" FontSize="12" TextColor="{StaticResource TextSecondary}"/>

                      <!-- Question input with trailing image icon -->
                      <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto">
                        <Editor Text="{Binding Question}" Placeholder="Type your question"
                                BackgroundColor="Transparent" TextColor="{StaticResource TextPrimary}"
                                PlaceholderColor="#97A1AD" 
                                AutoSize="TextChanges"
                                MinimumHeightRequest="40"
                                MaximumHeightRequest="200" />
                        <Label Grid.Column="1" Text="&#xF03E;" FontFamily="FontAwesome6FreeSolid" FontSize="16"
                               TextColor="#6C4DF7" VerticalOptions="Start" Margin="8,8,0,0"
                               ToolTipProperties.Text="Add image to question">
                          <Label.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnPickImageTapped" CommandParameter="Q"/>
                          </Label.GestureRecognizers>
                        </Label>
                      </Grid>

                      <!-- Optional image preview for question -->
                      <Image Source="{Binding QuestionImagePath}" HeightRequest="120" Aspect="AspectFill" IsVisible="{Binding QuestionImageVisible}"/>

                      <Label Text="Answer (Term)" FontSize="12" TextColor="{StaticResource TextSecondary}"/>

                      <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto">
                        <Editor Text="{Binding Answer}" Placeholder="Type the answer"
                                BackgroundColor="Transparent" TextColor="{StaticResource TextPrimary}"
                                PlaceholderColor="#97A1AD" 
                                AutoSize="TextChanges"
                                MinimumHeightRequest="40"
                                MaximumHeightRequest="200" />
                        <Label Grid.Column="1" Text="&#xF03E;" FontFamily="FontAwesome6FreeSolid" FontSize="16"
                               TextColor="#6C4DF7" VerticalOptions="Start" Margin="8,8,0,0"
                               ToolTipProperties.Text="Add image to answer">
                          <Label.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnPickImageTapped" CommandParameter="A"/>
                          </Label.GestureRecognizers>
                        </Label>
                      </Grid>

                      <!-- Optional image preview for answer -->
                      <Image Source="{Binding AnswerImagePath}" HeightRequest="120" Aspect="AspectFill" IsVisible="{Binding AnswerImageVisible}"/>
                    </VerticalStackLayout>

                    <!-- ===== SAVED PANEL ===== -->
                    <Grid x:Name="SavedPanel" IsVisible="{Binding IsSaved}">
                      <Grid.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnCardTapped" />
                      </Grid.GestureRecognizers>
                      <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                      </Grid.ColumnDefinitions>

                      <!-- Number badge -->
                      <Label Text="{Binding Number, StringFormat='{0}'}" FontAttributes="Bold" FontSize="18"
                             TextColor="{StaticResource TextPrimary}"
                             VerticalOptions="Start" Margin="0,4,10,0"/>

                      <VerticalStackLayout Grid.Column="1" Spacing="6" Margin="0,0,40,0">
                        <Label Text="{Binding Question}" FontSize="15" TextColor="{StaticResource TextPrimary}"/>
                        <Image Source="{Binding QuestionImagePath}" HeightRequest="100" Aspect="AspectFill" IsVisible="{Binding QuestionImageVisible}"/>
                        <BoxView HeightRequest="1" BackgroundColor="{StaticResource Divider}"/>
                        <Label Text="{Binding Answer}" FontSize="14" TextColor="{StaticResource TextSecondary}"/>
                        <Image Source="{Binding AnswerImagePath}" HeightRequest="100" Aspect="AspectFill" IsVisible="{Binding AnswerImageVisible}"/>
                      </VerticalStackLayout>
                    </Grid>

                  </Grid>
                </Border>
              </DataTemplate>
            </CollectionView.ItemTemplate>
          </CollectionView>

          <!-- Add new question -->
          <Grid Padding="16,6">
            <Border Style="{StaticResource PillPrimary}" Padding="16,12" HorizontalOptions="Center" WidthRequest="260"
                    ToolTipProperties.Text="Add new question (Ctrl+N)">
              <Grid ColumnDefinitions="Auto,*" VerticalOptions="Center">
                <Label Text="&#x2b;" FontSize="18" TextColor="White"
                       HorizontalOptions="Start" VerticalOptions="Center" />
                <Label Grid.Column="1" Text="ADD NEW QUESTION" TextColor="White"
                       FontAttributes="Bold" FontSize="14" VerticalOptions="Center" />
              </Grid>
              <Border.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnAddNewTapped"/>
              </Border.GestureRecognizers>
            </Border>
          </Grid>

        </VerticalStackLayout>
      </ScrollView>
    </Grid>
    
    <!-- Inline rename overlay -->
    <Grid x:Name="RenameOverlay" IsVisible="False" BackgroundColor="#80000000" Grid.RowSpan="2">
      <Border BackgroundColor="White" StrokeThickness="0" Padding="20" StrokeShape="RoundRectangle 16"
              HorizontalOptions="Center" VerticalOptions="Center" WidthRequest="340" MaximumHeightRequest="400">
        <VerticalStackLayout Spacing="12">
          <Label Text="Rename Deck" FontAttributes="Bold" FontSize="18" TextColor="{StaticResource TextPrimary}"/>
          <Label Text="You can use multiple lines for a descriptive title" FontSize="12" TextColor="{StaticResource TextSecondary}" Margin="0,0,0,4"/>
          <Editor x:Name="RenameEntry" 
                  Placeholder="Enter deck name" 
                  TextColor="Black" 
                  Text="{Binding ReviewerTitle}"
                  AutoSize="TextChanges"
                  MinimumHeightRequest="60"
                  MaximumHeightRequest="150"
                  BackgroundColor="#F5F7FA"
                  Margin="0,0,0,8"/>
          <HorizontalStackLayout Spacing="10" HorizontalOptions="End">
            <Button Text="Cancel" 
                    Clicked="OnRenameCancel"
                    BackgroundColor="#E0E0E0"
                    TextColor="Black"
                    CornerRadius="8"
                    Padding="20,10"/>
            <Button Text="Save" 
                    Clicked="OnRenameSave"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    CornerRadius="8"
                    Padding="20,10"/>
          </HorizontalStackLayout>
        </VerticalStackLayout>
      </Border>
    </Grid>
    
    <!-- Reusable bottom sheet lives at top Grid level -->
    <controls:BottomSheetMenu x:Name="MainMenu" Grid.RowSpan="2" ZIndex="50"/>

    <!-- Spinner overlay -->
    <ActivityIndicator
        x:Name="LoadingSpinner"
        IsRunning="{Binding IsLoading}"
        IsVisible="{Binding IsLoading}"
        VerticalOptions="CenterAndExpand"
        HorizontalOptions="CenterAndExpand"
        Color="DeepSkyBlue"
        Scale="1.3"
        Grid.RowSpan="2" />
  </Grid>
</ContentPage>