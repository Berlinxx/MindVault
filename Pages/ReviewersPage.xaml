<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
  x:Class="mindvault.Pages.ReviewersPage"
  xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
  xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
  xmlns:controls="clr-namespace:mindvault.Controls"
  xmlns:conv="clr-namespace:mindvault.Converters"
  Shell.NavBarIsVisible="False">

  <!-- ===== THEME ===== -->
  <ContentPage.Resources>
    <Color x:Key="Primary">#31B6D8</Color>
    <Color x:Key="PrimaryDark">#0B57C1</Color>
    <Color x:Key="Ink">#0D3848</Color>
    <Color x:Key="Surface">#FFFFFF</Color>
    <Color x:Key="TextPrimary">#1C1C1C</Color>
    <Color x:Key="TextSecondary">#55616E</Color>
    <Color x:Key="Divider">#E8EDF2</Color>

    <!-- Card style -->
    <Style x:Key="CardStyle" TargetType="Border">
      <Setter Property="BackgroundColor" Value="{StaticResource Surface}" />
      <Setter Property="StrokeThickness" Value="0" />
      <Setter Property="StrokeShape" Value="RoundRectangle 18" />
      <Setter Property="Padding" Value="16" />
      <Setter Property="Shadow">
        <Setter.Value>
          <Shadow Opacity="0.18" Radius="16">
            <Shadow.Offset><Point X="0" Y="8"/></Shadow.Offset>
          </Shadow>
        </Setter.Value>
      </Setter>
    </Style>
    <conv:TruncateConverter x:Key="TruncateConverter" />

    <!-- Filled primary pill -->
    <Style x:Key="PrimaryPill" TargetType="Border">
      <Setter Property="StrokeShape" Value="RoundRectangle 20" />
      <Setter Property="BackgroundColor" Value="{StaticResource Ink}" />
      <Setter Property="Padding" Value="16,12" />
      <Setter Property="VisualStateManager.VisualStateGroups">
        <Setter.Value>
          <VisualStateGroupList>
            <VisualStateGroup>
              <VisualState x:Name="Normal"/>
              <VisualState x:Name="Pressed">
                <VisualState.Setters>
                  <Setter Property="VisualElement.Opacity" Value="0.92"/>
                </VisualState.Setters>
              </VisualState>
            </VisualStateGroup>
          </VisualStateGroupList>
        </Setter.Value>
      </Setter>
    </Style>

    <!-- Outlined picker container -->
    <Style x:Key="OutlineField" TargetType="Border">
      <Setter Property="Stroke" Value="{StaticResource Primary}" />
      <Setter Property="StrokeThickness" Value="2" />
      <Setter Property="StrokeShape" Value="RoundRectangle 10" />
      <Setter Property="Padding" Value="12,6" />
      <Setter Property="BackgroundColor" Value="White" />
    </Style>
  </ContentPage.Resources>

  <!-- ===== BACKGROUND GRADIENT ===== -->
  <ContentPage.Background>
    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
      <GradientStop Color="#3CC5F0" Offset="0" />
      <GradientStop Color="#0B57C1" Offset="1" />
    </LinearGradientBrush>
  </ContentPage.Background>

  <Grid x:Name="RootGrid" RowDefinitions="Auto,*">

    <!-- ===== HEADER ===== -->
    <Border Grid.Row="0" BackgroundColor="White" StrokeThickness="0"
            StrokeShape="RoundRectangle 0,0,18,18"
            Padding="12,10" Margin="0,0,0,6">
      <Grid ColumnDefinitions="Auto,*,Auto" VerticalOptions="Center">

        <controls:HamburgerButton x:Name="HamburgerButton" />

        <Label Grid.Column="1" Text="REVIEWERS"
               FontAttributes="Bold" FontSize="18"
               TextColor="{StaticResource TextPrimary}"
               VerticalOptions="Center" HorizontalOptions="Start">
          <Label.GestureRecognizers>
            <TapGestureRecognizer Tapped="OnTitleTripleTapped" NumberOfTapsRequired="3" />
          </Label.GestureRecognizers>
        </Label>

        <!-- Search circle -->
        <Border Grid.Column="2" WidthRequest="34" HeightRequest="34"
                StrokeThickness="2" Stroke="{StaticResource Primary}"
                StrokeShape="Ellipse" BackgroundColor="White"
                ToolTipProperties.Text="Search reviewers">
          <Label Text="&#xF002;" FontFamily="FontAwesome6FreeSolid" FontSize="14"
                 TextColor="{StaticResource Primary}"
                 HorizontalOptions="Center" VerticalOptions="Center"/>
          <Border.GestureRecognizers>
            <TapGestureRecognizer Tapped="OnSearchTapped" />
          </Border.GestureRecognizers>
        </Border>
      </Grid>
    </Border>

    <!-- ===== BODY ===== -->
    <ScrollView Grid.Row="1">
      <VerticalStackLayout Spacing="16" Padding="16,8,16,28">

        <!-- SearchBar (toggles when tapping magnifying glass) -->
        <SearchBar x:Name="DeckSearchBar"
                   IsVisible="{Binding IsSearchVisible}"
                   Placeholder="Search reviewers..."
                   Text="{Binding SearchText, Mode=TwoWay}"
                   FontSize="14"/>

        <!-- YOUR REVIEWERS + sort -->
        <Border Style="{StaticResource CardStyle}">
          <VerticalStackLayout Spacing="12">
            <Label Text="YOUR REVIEWERS" FontAttributes="Bold" FontSize="16"
                   TextColor="{StaticResource TextPrimary}"/>

            <Grid RowDefinitions="Auto,Auto">
              <Label Text="Sort by:" Grid.Row="0"
                     FontSize="12" TextColor="{StaticResource TextSecondary}"/>

              <!-- Dropdown trigger button -->
              <Border x:Name="DropdownTrigger" Grid.Row="1" 
                      Stroke="#E8EDF2" StrokeThickness="1"
                      StrokeShape="RoundRectangle 8" Padding="12,10" BackgroundColor="#FFFFFF"
                      ToolTipProperties.Text="Change sort order">
                <Grid ColumnDefinitions="*,Auto">
                  <Label Grid.Column="0" Text="{Binding SelectedSort}" 
                         TextColor="#000000" FontSize="14" VerticalOptions="Center"/>
                  <Label Grid.Column="1" Text="&#xF078;" FontFamily="FontAwesome6FreeSolid" FontSize="10"
                         VerticalOptions="Center" TextColor="#666666" Margin="8,0,0,0"/>
                </Grid>
                <Border.GestureRecognizers>
                  <TapGestureRecognizer Tapped="OnDropdownTapped"/>
                </Border.GestureRecognizers>
              </Border>
            </Grid>
          </VerticalStackLayout>
        </Border>

        <!-- REVIEWER CARD LIST (shows when loaded) -->
        <CollectionView x:Name="ReviewerListView" ItemsSource="{Binding Reviewers}" SelectionMode="None" IsVisible="{Binding IsLoaded}" ItemSizingStrategy="MeasureFirstItem">
          <CollectionView.ItemsLayout>
            <LinearItemsLayout Orientation="Vertical" ItemSpacing="8" />
          </CollectionView.ItemsLayout>
          <CollectionView.ItemTemplate>
            <DataTemplate>
              <Border Style="{StaticResource CardStyle}">
                <VerticalStackLayout Spacing="12">

                  <!-- Header strip: title pill sizes to content; spacer pushes the buttons to the right -->
                  <Grid ColumnDefinitions="Auto,*,Auto,Auto" VerticalOptions="Center">
                      <!-- Title pill (auto width based on text length) -->
                      <Border Grid.Column="0" BackgroundColor="{StaticResource Ink}"
                          StrokeThickness="0"
                          StrokeShape="RoundRectangle 12"
                          Padding="12,8"
                          Margin="0,0,0,0"
                          HorizontalOptions="Start">
                        <Label Text="{Binding Title, Converter={StaticResource TruncateConverter}, ConverterParameter={OnPlatform Android=15, WinUI=20, Default=20}}"
                           TextColor="White" FontAttributes="Bold"/>
                      </Border>

                      <!-- Invisible spacer that blends with the card to push icons to the right -->
                      <BoxView Grid.Column="1" BackgroundColor="{StaticResource Surface}" />

                    <!-- trash/delete icon (fixed on right) -->
                    <Border Grid.Column="2" WidthRequest="34" HeightRequest="34"
                            Stroke="#DDE4EA" StrokeThickness="1"
                            StrokeShape="Ellipse" BackgroundColor="White"
                            Margin="0,0,8,0"
                            ToolTipProperties.Text="Delete reviewer">
                      <Label Text="&#xF1F8;" FontFamily="FontAwesome6FreeSolid" FontSize="14" TextColor="#E74C3C"
                             HorizontalOptions="Center" VerticalOptions="Center"/>
                      <Border.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnDeleteTapped"/>
                      </Border.GestureRecognizers>
                    </Border>

                    <!-- export/share icon (fixed on right) -->
                    <Border Grid.Column="3" WidthRequest="34" HeightRequest="34"
                            Stroke="#DDE4EA" StrokeThickness="1"
                            StrokeShape="Ellipse" BackgroundColor="White"
                            ToolTipProperties.Text="Export reviewer to file">
                      <Label Text="&#xF35D;" FontFamily="FontAwesome6FreeSolid" FontSize="14" TextColor="{StaticResource Primary}"
                             HorizontalOptions="Center" VerticalOptions="Center"/>
                      <Border.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnExportTapped"/>
                      </Border.GestureRecognizers>
                    </Border>
                  </Grid>

                  <!-- Content -->
                  <VerticalStackLayout Spacing="10" Padding="6,0,6,0">
                    <Grid ColumnDefinitions="Auto,Auto,*" VerticalOptions="Center">
                      <Label Text="Questions:" FontSize="14" TextColor="{StaticResource TextPrimary}"/>
                      <Label Grid.Column="1" Text="{Binding Questions}" FontSize="14" FontAttributes="Bold"
                             TextColor="{StaticResource TextPrimary}" Margin="4,0,0,0"/>
                      <Label Grid.Column="2" Text="&#xF303;" FontFamily="FontAwesome6FreeSolid" FontSize="12"
                             TextColor="{StaticResource Primary}" HorizontalOptions="Start" Margin="6,0,0,0"
                             ToolTipProperties.Text="Edit questions">
                        <Label.GestureRecognizers>
                          <TapGestureRecognizer Tapped="OnEditTapped" />
                        </Label.GestureRecognizers>
                      </Label>
                    </Grid>

                    <!-- Progress + due -->
                    <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto" >
                      <Label Grid.Column="0" Grid.Row="0" Text="{Binding ProgressPercentText}"
                             FontSize="12" TextColor="{StaticResource TextSecondary}"/>
                      <Label Grid.Column="1" Grid.Row="0" Text="{Binding DueText}"
                             FontSize="12" TextColor="#C5232D"/>

                      <ProgressBar Grid.ColumnSpan="2" Grid.Row="1"
                                   Progress="{Binding ProgressRatio}" HeightRequest="10"
                                   BackgroundColor="#E6EEF3" ProgressColor="{StaticResource PrimaryDark}" Margin="0,4,0,0"/>
                    </Grid>

                    <!-- VIEW COURSE -->
                    <Border Style="{StaticResource PrimaryPill}" Margin="0,6,0,0"
                            ToolTipProperties.Text="Start reviewing this course">
                      <Label Text="VIEW COURSE" TextColor="White" FontAttributes="Bold"
                             HorizontalOptions="Center" />
                      <Border.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnViewCourseTapped"/>
                      </Border.GestureRecognizers>
                    </Border>
                  </VerticalStackLayout>

                </VerticalStackLayout>
              </Border>
            </DataTemplate>
          </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Skeleton placeholders while loading -->
        <VerticalStackLayout x:Name="SkeletonList" IsVisible="{Binding IsLoadingReviewers}" Spacing="12">
          <Border Style="{StaticResource CardStyle}">
            <VerticalStackLayout Spacing="10">
              <BoxView HeightRequest="20" Color="#E6EEF3" CornerRadius="6" />
              <BoxView HeightRequest="12" Color="#F0F4F8" CornerRadius="6" WidthRequest="120" />
              <BoxView HeightRequest="10" Color="#E6EEF3" CornerRadius="6" Margin="0,4,0,0" />
            </VerticalStackLayout>
          </Border>
          <Border Style="{StaticResource CardStyle}">
            <VerticalStackLayout Spacing="10">
              <BoxView HeightRequest="20" Color="#E6EEF3" CornerRadius="6" />
              <BoxView HeightRequest="12" Color="#F0F4F8" CornerRadius="6" WidthRequest="140" />
              <BoxView HeightRequest="10" Color="#E6EEF3" CornerRadius="6" Margin="0,4,0,0" />
            </VerticalStackLayout>
          </Border>
          <Border Style="{StaticResource CardStyle}">
            <VerticalStackLayout Spacing="10">
              <BoxView HeightRequest="20" Color="#E6EEF3" CornerRadius="6" />
              <BoxView HeightRequest="12" Color="#F0F4F8" CornerRadius="6" WidthRequest="100" />
              <BoxView HeightRequest="10" Color="#E6EEF3" CornerRadius="6" Margin="0,4,0,0" />
            </VerticalStackLayout>
          </Border>
          <Border Style="{StaticResource CardStyle}">
            <VerticalStackLayout Spacing="10">
              <BoxView HeightRequest="20" Color="#E6EEF3" CornerRadius="6" />
              <BoxView HeightRequest="12" Color="#F0F4F8" CornerRadius="6" WidthRequest="160" />
              <BoxView HeightRequest="10" Color="#E6EEF3" CornerRadius="6" Margin="0,4,0,0" />
            </VerticalStackLayout>
          </Border>
        </VerticalStackLayout>

        <!-- CREATE REVIEWER -->
        <Border x:Name="CreatePill"
                Style="{StaticResource PrimaryPill}"
                HorizontalOptions="Center"
                WidthRequest="260"
                Margin="0,6,0,0"
                ToolTipProperties.Text="Create a new reviewer deck">
          <Label Text="+ CREATE REVIEWER"
                 FontAttributes="Bold" FontSize="16"
                 TextColor="White"
                 HorizontalOptions="Center"
                 VerticalOptions="Center"
                 HorizontalTextAlignment="Center" />
          <Border.GestureRecognizers>
            <TapGestureRecognizer Tapped="OnCreateReviewerTapped"/>
          </Border.GestureRecognizers>
        </Border>

        <!-- IMPORT -->
        <Border x:Name="ImportPill"
                BackgroundColor="#0E2F3A"
                Stroke="#93D3E3" StrokeThickness="1"
                StrokeShape="RoundRectangle 22"
                Padding="22,14"
                HorizontalOptions="Center"
                WidthRequest="260"
                Margin="0,6,0,0"
                ToolTipProperties.Text="Import reviewer from .txt file">
          <Label Text="+ IMPORT"
                 FontAttributes="Bold" FontSize="16"
                 TextColor="White"
                 HorizontalOptions="Center"
                 VerticalOptions="Center"
                 HorizontalTextAlignment="Center" />
          <Border.GestureRecognizers>
            <TapGestureRecognizer Tapped="OnImportTapped"/>
          </Border.GestureRecognizers>
        </Border>

      </VerticalStackLayout>
    </ScrollView>
    
    <!-- Loading overlay -->
    <Grid x:Name="LoadingOverlay" Grid.RowSpan="2"
          IsVisible="{Binding IsLoadingReviewers}"
          BackgroundColor="#80000000"
          VerticalOptions="FillAndExpand"
          HorizontalOptions="FillAndExpand"
          ZIndex="60">
      <ActivityIndicator IsRunning="True"
                         VerticalOptions="Center"
                         HorizontalOptions="Center"
                         Color="White"
                         Scale="1.2" />
    </Grid>

    <!-- Reusable bottom sheet lives at top Grid level -->
    <controls:BottomSheetMenu x:Name="MainMenu" Grid.RowSpan="2" ZIndex="50"/>

    <!-- Dropdown options list (overlay popup) -->
    <Border x:Name="DropdownList" IsVisible="False" 
            Grid.RowSpan="2"
            Stroke="#31B6D8" StrokeThickness="2"
            StrokeShape="RoundRectangle 8" 
            BackgroundColor="#FFFFFF"
            Padding="0"
            Margin="16,140,16,0"
            VerticalOptions="Start"
            HorizontalOptions="Fill"
            ZIndex="1000">
      <Border.Shadow>
        <Shadow Opacity="0.2" Radius="8" Offset="0,4"/>
      </Border.Shadow>
      <CollectionView ItemsSource="{Binding SortOptions}" SelectionMode="None">
        <CollectionView.ItemsLayout>
          <LinearItemsLayout Orientation="Vertical" ItemSpacing="0" />
        </CollectionView.ItemsLayout>
        <CollectionView.ItemTemplate>
          <DataTemplate>
            <Border BackgroundColor="#FFFFFF" Padding="12,10" StrokeThickness="0">
              <Label Text="{Binding}" TextColor="#000000" FontSize="14"/>
              <Border.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnDropdownItemTapped" 
                                      CommandParameter="{Binding}"/>
              </Border.GestureRecognizers>
            </Border>
          </DataTemplate>
        </CollectionView.ItemTemplate>
      </CollectionView>
    </Border>
  </Grid>
</ContentPage>
