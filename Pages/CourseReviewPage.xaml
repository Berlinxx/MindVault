<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="mindvault.Pages.CourseReviewPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:controls="clr-namespace:mindvault.Controls"
    xmlns:conv="clr-namespace:mindvault.Converters"
    Shell.NavBarIsVisible="False">

  <!-- THEME -->
  <ContentPage.Resources>
    <Color x:Key="Primary">#31B6D8</Color>
    <Color x:Key="PrimaryDark">#0B57C1</Color>
    <Color x:Key="Ink">#0D3848</Color>
    <Color x:Key="Surface">#FFFFFF</Color>
    <Color x:Key="TextPrimary">#1C1C1C</Color>
    <Color x:Key="TextSecondary">#59636F</Color>
    <Color x:Key="Accent">#0E6A85</Color>
    <Color x:Key="BarBg">#F2F6FA</Color>
    <Color x:Key="CorrectColor">#0BA85A</Color>
    <Color x:Key="WrongColor">#E33A3A</Color>

    <Style x:Key="CardStyle" TargetType="Border">
      <Setter Property="BackgroundColor" Value="{StaticResource Surface}" />
      <Setter Property="StrokeThickness" Value="0" />
      <Setter Property="StrokeShape" Value="RoundRectangle 12" />
      <Setter Property="Padding" Value="12" />
      <Setter Property="Shadow">
        <Setter.Value>
          <Shadow Opacity="0.18" Radius="16">
            <Shadow.Offset><Point X="0" Y="8"/></Shadow.Offset>
          </Shadow>
        </Setter.Value>
      </Setter>
    </Style>

    <Style x:Key="Pill" TargetType="Border">
      <Setter Property="StrokeShape" Value="RoundRectangle 18" />
      <Setter Property="Padding" Value="16,10" />
      <Setter Property="BackgroundColor" Value="#2B6B8A" />
      <Setter Property="HorizontalOptions" Value="Center" />
      <Setter Property="VisualStateManager.VisualStateGroups">
        <Setter.Value>
          <VisualStateGroupList>
            <VisualStateGroup>
              <VisualState x:Name="Normal"/>
              <VisualState x:Name="Pressed">
                <VisualState.Setters>
                  <Setter Property="VisualElement.Opacity" Value="0.92"/>
                </VisualState.Setters>
              </VisualState>
            </VisualStateGroup>
          </VisualStateGroupList>
        </Setter.Value>
      </Setter>
    </Style>

    <!-- Converters -->
    <conv:InverseBoolConverter x:Key="InverseBoolConverter" />
    <conv:TruncateConverter x:Key="TruncateConverter" />
  </ContentPage.Resources>

  <!-- BACKGROUND -->
  <ContentPage.Background>
    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
      <GradientStop Color="#3CC5F0" Offset="0" />
      <GradientStop Color="#0B57C1" Offset="1" />
    </LinearGradientBrush>
  </ContentPage.Background>

  <Grid RowDefinitions="Auto,*">

    <!-- HEADER -->
    <Border Grid.Row="0" BackgroundColor="White" StrokeThickness="0"
            StrokeShape="RoundRectangle 0,0,18,18" Padding="12,10" Margin="0,0,0,8">
      <Grid ColumnDefinitions="Auto,*,Auto,Auto" VerticalOptions="Center">
        <controls:HamburgerButton x:Name="HamburgerButton" />

        <HorizontalStackLayout Grid.Column="1" Spacing="6" VerticalOptions="Center">
          <Label Text="{Binding Title, Converter={StaticResource TruncateConverter}, ConverterParameter=15}"
                 FontAttributes="Bold" FontSize="20" TextColor="{StaticResource TextPrimary}"
                 SemanticProperties.HeadingLevel="Level1"
                 SemanticProperties.Description="Deck title" />

          <Border WidthRequest="34" HeightRequest="34" Stroke="#E8EDF2" StrokeThickness="1"
                  StrokeShape="Ellipse" BackgroundColor="White" HorizontalOptions="Center" VerticalOptions="Center" Margin="2,0,0,0"
                  ToolTipProperties.Text="Deck settings"
                  SemanticProperties.Description="Settings button"
                  SemanticProperties.Hint="Opens deck settings and preferences">
            <Label Text="&#xF013;" FontFamily="FontAwesome6FreeSolid" FontSize="15" TextColor="{StaticResource Primary}"
                   HorizontalOptions="Center" VerticalOptions="Center"/>
            <Border.GestureRecognizers>
              <TapGestureRecognizer Tapped="OnSettingsTapped"/>
            </Border.GestureRecognizers>
          </Border>
        </HorizontalStackLayout>

        <!-- (optional) settings icon space already above; here is close X -->
        <Border Grid.Column="3" WidthRequest="34" HeightRequest="34"
                Stroke="#E8EDF2" StrokeThickness="1" StrokeShape="Ellipse" BackgroundColor="White"
                ToolTipProperties.Text="Exit review session"
                SemanticProperties.Description="Close button"
                SemanticProperties.Hint="Exits the review session and returns to deck list">
          <Label Text="&#xF00D;" FontFamily="FontAwesome6FreeSolid" FontSize="14" TextColor="{StaticResource TextPrimary}"
                 HorizontalOptions="Center" VerticalOptions="Center"/>
          <Border.GestureRecognizers>
            <TapGestureRecognizer Tapped="OnCloseTapped"/>
          </Border.GestureRecognizers>
        </Border>
      </Grid>
    </Border>

    <!-- BODY -->
    <ScrollView Grid.Row="1">
      <VerticalStackLayout Spacing="12" Padding="16,0,16,24">

        <!-- Progress bar -->
        <Border BackgroundColor="{StaticResource BarBg}" HeightRequest="14"
                StrokeShape="RoundRectangle 8" StrokeThickness="0"
                SemanticProperties.Description="Review progress indicator">
          <Border BackgroundColor="{StaticResource PrimaryDark}" StrokeThickness="0"
                  StrokeShape="RoundRectangle 8"
                  HorizontalOptions="Start" WidthRequest="{Binding ProgressWidth}" />
        </Border>

        <!-- Stats strip -->
        <Border Style="{StaticResource CardStyle}">
          <Grid ColumnDefinitions="*,*,*,*,*" Padding="4,6">
            <VerticalStackLayout Spacing="0" Grid.Column="0" HorizontalOptions="Center">
              <Label Text="Avail" FontSize="11" TextColor="{StaticResource TextSecondary}" />
              <Label Text="{Binding Avail}" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}" HorizontalTextAlignment="Center" />
              <VerticalStackLayout.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnBucketTapped" CommandParameter="Avail"/>
              </VerticalStackLayout.GestureRecognizers>
            </VerticalStackLayout>
            <VerticalStackLayout Spacing="0" Grid.Column="1" HorizontalOptions="Center">
              <Label Text="Seen" FontSize="11" TextColor="{StaticResource TextSecondary}" />
              <Label Text="{Binding Seen}" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}" HorizontalTextAlignment="Center" />
              <VerticalStackLayout.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnBucketTapped" CommandParameter="Seen"/>
              </VerticalStackLayout.GestureRecognizers>
            </VerticalStackLayout>
            <VerticalStackLayout Spacing="0" Grid.Column="2" HorizontalOptions="Center">
              <Label Text="Learned" FontSize="11" TextColor="{StaticResource TextSecondary}" />
              <Label Text="{Binding Learned}" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}" HorizontalTextAlignment="Center" />
              <VerticalStackLayout.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnBucketTapped" CommandParameter="Learned"/>
              </VerticalStackLayout.GestureRecognizers>
            </VerticalStackLayout>
            <VerticalStackLayout Spacing="0" Grid.Column="3" HorizontalOptions="Center">
              <Label Text="Skilled" FontSize="11" TextColor="{StaticResource TextSecondary}" />
              <Label Text="{Binding Skilled}" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}" HorizontalTextAlignment="Center" />
              <VerticalStackLayout.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnBucketTapped" CommandParameter="Skilled"/>
              </VerticalStackLayout.GestureRecognizers>
            </VerticalStackLayout>
            <VerticalStackLayout Spacing="0" Grid.Column="4" HorizontalOptions="Center">
              <Label Text="Memorized" FontSize="11" TextColor="{StaticResource TextSecondary}" />
              <Label Text="{Binding Memorized}" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}" HorizontalTextAlignment="Center" />
              <VerticalStackLayout.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnBucketTapped" CommandParameter="Memorized"/>
              </VerticalStackLayout.GestureRecognizers>
            </VerticalStackLayout>
          </Grid>
        </Border>

        <!-- Flashcard -->
        <Border x:Name="CardBorder" Style="{StaticResource CardStyle}" Padding="14" HeightRequest="420">
          <Grid>
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto"/>
              <RowDefinition Height="*"/>
              <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <Label Text="{Binding FaceTag}" Grid.Row="0" FontSize="12"
                   TextColor="{StaticResource TextSecondary}" />

            <!-- Content area: shows text+image, or centers text when no image -->
            <Grid Grid.Row="1">
              <!-- With image: stack text over image -->
              <Grid IsVisible="{Binding FaceImageVisible}">
                <VerticalStackLayout Spacing="8" HorizontalOptions="Center">
                  <Label Text="{Binding FaceText}" FontSize="{Binding FaceFontSize}" TextColor="{StaticResource TextPrimary}"
                         HorizontalTextAlignment="Center" />
                  <Image x:Name="FaceImageView" Source="{Binding FaceImage}" Aspect="AspectFit" HeightRequest="240">
                    <Image.GestureRecognizers>
                      <TapGestureRecognizer Tapped="OnImageTapped"/>
                    </Image.GestureRecognizers>
                  </Image>
                </VerticalStackLayout>
              </Grid>

              <!-- No image: center text vertically/horizontally -->
              <Grid IsVisible="{Binding FaceImageVisible, Converter={StaticResource InverseBoolConverter}}">
                <Label Text="{Binding FaceText}" FontSize="{Binding FaceFontSize}" TextColor="{StaticResource TextPrimary}"
                       HorizontalOptions="Center" VerticalOptions="Center"
                       HorizontalTextAlignment="Center" VerticalTextAlignment="Center" />
              </Grid>
            </Grid>

            <!-- Bottom of card: skip chip + speaker -->
            <Grid Grid.Row="2" ColumnDefinitions="*,Auto,Auto" Padding="0,10,0,0">
              <Border Grid.Column="1" BackgroundColor="#E6E6E6"
                      StrokeShape="RoundRectangle 14" Padding="16,6"
                      ToolTipProperties.Text="Skip this card (E, Tab)"
                      SemanticProperties.Description="Skip button"
                      SemanticProperties.Hint="Moves to the next card without answering">
                <HorizontalStackLayout Spacing="8">
                  <Label Text="Skip" />
                  <Label Text="&#xF061;" FontFamily="FontAwesome6FreeSolid" FontSize="12" />
                </HorizontalStackLayout>
                <Border.GestureRecognizers>
                  <TapGestureRecognizer Tapped="OnSkip"/>
                </Border.GestureRecognizers>
              </Border>

              <Border x:Name="SpeakButton" Grid.Column="2" WidthRequest="34" HeightRequest="34"
                      Stroke="#E8EDF2" StrokeThickness="1" StrokeShape="Ellipse" BackgroundColor="White" Margin="10,0,0,0"
                      ToolTipProperties.Text="Read text aloud (Q)"
                      SemanticProperties.Description="Text to speech button"
                      SemanticProperties.Hint="Reads the current card text aloud">
                <Label Text="&#xF028;" FontFamily="FontAwesome6FreeSolid" FontSize="14" TextColor="{StaticResource TextPrimary}"
                       HorizontalOptions="Center" VerticalOptions="Center"/>
                <Border.GestureRecognizers>
                  <TapGestureRecognizer Tapped="OnSpeakTapped"/>
                </Border.GestureRecognizers>
              </Border>
            </Grid>
          </Grid>
        </Border>

        <!-- Bottom controls -->
        <Grid ColumnDefinitions="*,Auto,*" Padding="6,4,6,0">
          <!-- Fail -->
          <Border
            x:Name="FailButton"
            Grid.Column="0"
            BackgroundColor="#C5D6E4"
            IsEnabled="{Binding AnswerButtonsEnabled}"
            Style="{StaticResource Pill}"
            ToolTipProperties.Text="Mark as incorrect (A, ←)"
            SemanticProperties.Description="Incorrect button"
            SemanticProperties.Hint="Marks this card as incorrectly answered">
            <Border.Triggers>
              <DataTrigger
                Binding="{Binding IsEnabled, Source={x:Reference FailButton}}"
                TargetType="Border"
                Value="False">
                <Setter Property="Opacity" Value="0.5" />
              </DataTrigger>
            </Border.Triggers>
            <Grid ColumnDefinitions="Auto,*">
              <Label Text="&#xF00D;" FontFamily="FontAwesome6FreeSolid" TextColor="{StaticResource Ink}" />
              <Label Grid.Column="1" Text="" />
            </Grid>
            <Border.GestureRecognizers>
              <TapGestureRecognizer Tapped="OnFail"/>
            </Border.GestureRecognizers>
          </Border>

          <!-- Flip -->
          <Border Grid.Column="1" BackgroundColor="White" Style="{StaticResource Pill}" Margin="12,0"
                  ToolTipProperties.Text="Flip card (Space, W, S, ↑, ↓)"
                  SemanticProperties.Description="Flip card button"
                  SemanticProperties.Hint="Flips the card to show the answer or question">
            <Label Text="Flip" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}" />
            <Border.GestureRecognizers>
              <TapGestureRecognizer Tapped="OnFlip"/>
            </Border.GestureRecognizers>
          </Border>

          <!-- Pass -->
          <Border
            x:Name="PassButton"
            Grid.Column="2"
            BackgroundColor="#8AB8D3"
            IsEnabled="{Binding AnswerButtonsEnabled}"
            Style="{StaticResource Pill}"
            ToolTipProperties.Text="Mark as correct (D, →)"
            SemanticProperties.Description="Correct button"
            SemanticProperties.Hint="Marks this card as correctly answered">
            <Border.Triggers>
              <DataTrigger
                Binding="{Binding IsEnabled, Source={x:Reference PassButton}}"
                TargetType="Border"
                Value="False">
                <Setter Property="Opacity" Value="0.5" />
              </DataTrigger>
            </Border.Triggers>
            <Grid ColumnDefinitions="*,Auto">
              <Label Text="" />
              <Label Grid.Column="1" Text="&#xF00C;" FontFamily="FontAwesome6FreeSolid" TextColor="White" />
            </Grid>
            <Border.GestureRecognizers>
              <TapGestureRecognizer Tapped="OnPass"/>
            </Border.GestureRecognizers>
          </Border>
        </Grid>

      </VerticalStackLayout>
    </ScrollView>

    <!-- Reusable bottom sheet lives at top Grid level -->
    <controls:BottomSheetMenu x:Name="MainMenu" Grid.RowSpan="2" ZIndex="50"/>

    <!-- COMPLETION OVERLAY -->
    <Grid x:Name="CompletionOverlay" Grid.RowSpan="2" BackgroundColor="#B3000000" IsVisible="{Binding SessionComplete}" Opacity="0">
      <!-- wrap inner content in a 3-column container so the content is precisely centered -->
      <Grid RowDefinitions="Auto" Padding="20">
        <Grid ColumnDefinitions="*,Auto,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto" HorizontalOptions="Fill" VerticalOptions="Center">
          <Grid x:Name="ConfettiHost" Grid.RowSpan="6" Grid.Column="1" />
          <Border Grid.Row="0" Grid.Column="1" BackgroundColor="White" StrokeThickness="0" StrokeShape="RoundRectangle 16" Padding="18" WidthRequest="320" HorizontalOptions="Center">
            <VerticalStackLayout Spacing="12" HorizontalOptions="Center">
              <Label Text="Session Complete!" FontAttributes="Bold" FontSize="20" HorizontalTextAlignment="Center" TextColor="{StaticResource Surface}"/>

              <!-- Stats cards -->
              <HorizontalStackLayout Spacing="16" HorizontalOptions="Center">
                <Border BackgroundColor="#F2F6FA" StrokeShape="RoundRectangle 12" Padding="10" WidthRequest="120" HeightRequest="90" VerticalOptions="Center">
                  <VerticalStackLayout Spacing="4" HorizontalOptions="Center" VerticalOptions="Center">
                    <Label Text="Correct:" FontSize="12" TextColor="{StaticResource CorrectColor}" HorizontalTextAlignment="Center" FontAttributes="Bold" />
                    <Label Text="{Binding CorrectCount}" FontSize="40" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}" HorizontalOptions="Center" VerticalOptions="Center" HorizontalTextAlignment="Center" VerticalTextAlignment="Center" />
                  </VerticalStackLayout>
                </Border>
                <Border BackgroundColor="#F2F6FA" StrokeShape="RoundRectangle 12" Padding="10" WidthRequest="120" HeightRequest="90" VerticalOptions="Center">
                  <VerticalStackLayout Spacing="4" HorizontalOptions="Center" VerticalOptions="Center">
                    <Label Text="Wrong:" FontSize="12" TextColor="{StaticResource WrongColor}" HorizontalTextAlignment="Center" FontAttributes="Bold" />
                    <Label Text="{Binding WrongCount}" FontSize="40" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}" HorizontalOptions="Center" VerticalOptions="Center" HorizontalTextAlignment="Center" VerticalTextAlignment="Center" />
                  </VerticalStackLayout>
                </Border>
              </HorizontalStackLayout>

              <Label Text="{Binding ElapsedText}" FontSize="12" TextColor="{StaticResource Surface}" HorizontalTextAlignment="Center" />
              <Label Text="Need more data for estimate." FontSize="12" TextColor="{StaticResource Surface}" HorizontalTextAlignment="Center" />

              <Button Text="Study More" WidthRequest="280" HeightRequest="44" CornerRadius="8" BackgroundColor="White" TextColor="{StaticResource TextPrimary}" Clicked="OnStudyMore"/>
              <Button Text="Back to Reviewers" WidthRequest="280" HeightRequest="44" CornerRadius="8" BackgroundColor="White" TextColor="{StaticResource TextPrimary}" Clicked="OnBackToList"/>

            </VerticalStackLayout>
          </Border>
        </Grid>
      </Grid>
    </Grid>

    <!-- IMAGE OVERLAY -->
    <Grid x:Name="ImageOverlay" Grid.RowSpan="2" BackgroundColor="#B3000000" IsVisible="False" Opacity="0">
      <Grid RowDefinitions="*" ColumnDefinitions="*" Padding="20" HorizontalOptions="Fill" VerticalOptions="Fill">
        <Image x:Name="FullImage" Aspect="AspectFit" HorizontalOptions="Fill" VerticalOptions="Fill" />
        <Grid.GestureRecognizers>
          <TapGestureRecognizer Tapped="OnCloseImageOverlay"/>
        </Grid.GestureRecognizers>
      </Grid>
    </Grid>

  </Grid>
</ContentPage>
