<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="mindvault.Pages.HostLobbyPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    Shell.NavBarIsVisible="False">

  <!-- THEME -->
  <ContentPage.Resources>
    <Color x:Key="Primary">#31B6D8</Color>
    <Color x:Key="PrimaryDark">#0B57C1</Color>
    <Color x:Key="Ink">#0D3848</Color>
    <Color x:Key="Surface">#FFFFFF</Color>
    <Color x:Key="TextPrimary">#14181B</Color>
    <Color x:Key="TextSecondary">#5B6673</Color>
    <Color x:Key="Lavender">#DCCEF2</Color>
    <Color x:Key="Success">#2EA44F</Color>
    <Color x:Key="SuccessLight">#D8F5E5</Color>

    <Style x:Key="Card" TargetType="Border">
      <Setter Property="BackgroundColor" Value="{StaticResource Surface}" />
      <Setter Property="StrokeThickness" Value="0" />
      <Setter Property="StrokeShape" Value="RoundRectangle 22" />
      <Setter Property="Padding" Value="18" />
      <Setter Property="Margin" Value="16,10" />
      <Setter Property="Shadow">
        <Setter.Value>
          <Shadow Opacity="0.18" Radius="18">
            <Shadow.Offset><Point X="0" Y="10"/></Shadow.Offset>
          </Shadow>
        </Setter.Value>
      </Setter>
    </Style>

    <Style x:Key="OutlineField" TargetType="Border">
      <Setter Property="Stroke" Value="{StaticResource Primary}" />
      <Setter Property="StrokeThickness" Value="2" />
      <Setter Property="StrokeShape" Value="RoundRectangle 10" />
      <Setter Property="Padding" Value="12,6" />
      <Setter Property="BackgroundColor" Value="White" />
    </Style>

    <!-- Big gradient CTA -->
    <Style x:Key="PrimaryPill" TargetType="Border">
      <Setter Property="StrokeShape" Value="RoundRectangle 24" />
      <Setter Property="Padding" Value="22,14" />
      <Setter Property="HorizontalOptions" Value="Center" />
      <Setter Property="Background">
        <Setter.Value>
          <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#5EE2F5" Offset="0" />
            <GradientStop Color="#6C4DF7" Offset="1" />
          </LinearGradientBrush>
        </Setter.Value>
      </Setter>
      <Setter Property="Shadow">
        <Setter.Value>
          <Shadow Opacity="0.25" Radius="16">
            <Shadow.Offset><Point X="0" Y="8"/></Shadow.Offset>
          </Shadow>
        </Setter.Value>
      </Setter>
    </Style>
  </ContentPage.Resources>

  <!-- BACKGROUND -->
  <ContentPage.Background>
    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
      <GradientStop Color="#3CC5F0" Offset="0" />
      <GradientStop Color="#0B57C1" Offset="1" />
    </LinearGradientBrush>
  </ContentPage.Background>

  <Grid x:Name="RootGrid" RowDefinitions="Auto,*">
    
    <!-- HEADER -->
    <Border Grid.Row="0" BackgroundColor="White" StrokeThickness="0"
            StrokeShape="RoundRectangle 0,0,18,18"
            Padding="12,10" Margin="0,0,0,10">
      <Grid ColumnDefinitions="Auto,*,Auto" VerticalOptions="Center">
        <!-- Back button -->
        <Border WidthRequest="34" HeightRequest="34"
                Stroke="#E8EDF2" StrokeThickness="1"
                StrokeShape="Ellipse" BackgroundColor="White">
          <Label Text="&#xF060;" FontFamily="FontAwesome6FreeSolid" FontSize="14" TextColor="{StaticResource TextPrimary}"
                 HorizontalOptions="Center" VerticalOptions="Center"/>
          <Border.GestureRecognizers>
            <TapGestureRecognizer Tapped="OnBackTapped"/>
          </Border.GestureRecognizers>
        </Border>
        
        <Label Grid.Column="1" Text="HOST LOBBY"
               FontAttributes="Bold" FontSize="18"
               TextColor="{StaticResource TextPrimary}"
               VerticalOptions="Center" HorizontalOptions="Center" />
        
        <!-- Spacer to balance the layout -->
        <Border Grid.Column="2" WidthRequest="34" HeightRequest="34"
                Stroke="Transparent" StrokeThickness="0"
                StrokeShape="Ellipse" BackgroundColor="Transparent" />
      </Grid>
    </Border>

    <!-- BODY -->
    <ScrollView Grid.Row="1">
      <VerticalStackLayout Spacing="8" Padding="16,0,16,28">

      <!-- ROOM CODE + PICKER -->
      <Border Style="{StaticResource Card}">
        <VerticalStackLayout Spacing="14" HorizontalOptions="Fill">

          <!-- Room code line -->
          <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
            <Label Text="ROOM CODE:" TextColor="#1EA1FF" FontSize="18" FontAttributes="Bold"/>
            <Label Text="{Binding RoomCode}" TextColor="{StaticResource TextPrimary}"
                   FontSize="18" FontAttributes="Bold"/>
          </HorizontalStackLayout>

          <Label Text="CHOOSE FLASHCARD:" FontSize="13" TextColor="{StaticResource TextSecondary}"
                 HorizontalTextAlignment="Center"/>

          <!-- Custom Dropdown -->
          <Grid HorizontalOptions="Center" WidthRequest="250">
            <!-- Dropdown trigger button -->
            <Border x:Name="FlashcardDropdownTrigger" Stroke="#E8EDF2" StrokeThickness="1"
                    StrokeShape="RoundRectangle 8" Padding="12,10" BackgroundColor="#FFFFFF">
              <Grid ColumnDefinitions="*,Auto">
                <Label Grid.Column="0" Text="{Binding SelectedFlashcard}" 
                       TextColor="#000000" FontSize="14" VerticalOptions="Center"/>
                <Label Grid.Column="1" Text="&#xF078;" FontFamily="FontAwesome6FreeSolid" FontSize="10"
                       VerticalOptions="Center" TextColor="#666666" Margin="8,0,0,0"/>
              </Grid>
              <Border.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnFlashcardDropdownTapped"/>
              </Border.GestureRecognizers>
            </Border>
          </Grid>
        </VerticalStackLayout>
      </Border>

      <!-- PARTICIPANTS -->
      <Border Style="{StaticResource Card}">
        <VerticalStackLayout Spacing="12">
          <Label Text="{Binding ParticipantsHeader}" FontSize="14"
                 TextColor="{StaticResource TextPrimary}" />

          <CollectionView ItemsSource="{Binding Participants}"
                          SelectionMode="None"
                          Margin="0,4,0,0">
            <CollectionView.ItemsLayout>
              <!-- 4 across, like the mock -->
              <GridItemsLayout Orientation="Vertical" Span="4" />
            </CollectionView.ItemsLayout>

            <CollectionView.ItemTemplate>
              <DataTemplate>
                <VerticalStackLayout Spacing="6"
                                     HorizontalOptions="Center"
                                     Margin="0,4">
                  <Border WidthRequest="64" HeightRequest="64"
                          BackgroundColor="{StaticResource Lavender}"
                          StrokeThickness="0" StrokeShape="Ellipse">
                    <Border.Triggers>
                      <DataTrigger TargetType="Border" Binding="{Binding Ready}" Value="True">
                        <Setter Property="BackgroundColor" Value="{StaticResource SuccessLight}" />
                      </DataTrigger>
                    </Border.Triggers>
                    <Image Source="{Binding Image}" Aspect="AspectFill">
                      <Image.Clip>
                        <EllipseGeometry Center="32,32" RadiusX="32" RadiusY="32"/>
                      </Image.Clip>
                    </Image>
                  </Border>
                  <Label Text="{Binding Name}" FontSize="11" TextColor="{StaticResource TextSecondary}"
                         HorizontalTextAlignment="Center" />
                  <Label Text="READY" FontSize="10" TextColor="{StaticResource Success}"
                         IsVisible="{Binding Ready}"
                         HorizontalTextAlignment="Center" />
                </VerticalStackLayout>
              </DataTemplate>
            </CollectionView.ItemTemplate>
          </CollectionView>
        </VerticalStackLayout>
      </Border>

      <!-- CTA -->
      <Border Style="{StaticResource PrimaryPill}" Margin="0,10,0,0" IsEnabled="{Binding CanStart}">
        <Border.Triggers>
          <Trigger TargetType="Border" Property="IsEnabled" Value="False">
            <Setter Property="Opacity" Value="0.5" />
          </Trigger>
          <Trigger TargetType="Border" Property="IsEnabled" Value="True">
            <Setter Property="Opacity" Value="1" />
          </Trigger>
        </Border.Triggers>
        <Label Text="LET`S GO!" TextColor="White" FontAttributes="Bold" FontSize="16"
               HorizontalOptions="Center"/>
        <Border.GestureRecognizers>
          <TapGestureRecognizer Tapped="OnLetsGoTapped"/>
        </Border.GestureRecognizers>
      </Border>

    </VerticalStackLayout>
  </ScrollView>

    <!-- Dropdown options list (overlay popup) -->
    <Border x:Name="FlashcardDropdownList" IsVisible="False" 
            Grid.RowSpan="2"
            Stroke="#31B6D8" StrokeThickness="2"
            StrokeShape="RoundRectangle 8" 
            BackgroundColor="#FFFFFF"
            Padding="0"
            Margin="0,180,0,0"
            VerticalOptions="Start"
            HorizontalOptions="Center"
            WidthRequest="250"
            ZIndex="1000">
      <Border.Shadow>
        <Shadow Opacity="0.2" Radius="8" Offset="0,4"/>
      </Border.Shadow>
      <CollectionView ItemsSource="{Binding FlashcardOptions}" SelectionMode="None">
        <CollectionView.ItemsLayout>
          <LinearItemsLayout Orientation="Vertical" ItemSpacing="0" />
        </CollectionView.ItemsLayout>
        <CollectionView.ItemTemplate>
          <DataTemplate>
            <Border BackgroundColor="#FFFFFF" Padding="12,10" StrokeThickness="0">
              <Label Text="{Binding}" TextColor="#000000" FontSize="14"/>
              <Border.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnFlashcardDropdownItemTapped" 
                                      CommandParameter="{Binding}"/>
              </Border.GestureRecognizers>
            </Border>
          </DataTemplate>
        </CollectionView.ItemTemplate>
      </CollectionView>
    </Border>
  </Grid>
</ContentPage>
